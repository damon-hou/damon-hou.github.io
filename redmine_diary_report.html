<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine 每日工時追蹤器 (自動同步修復版)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .timer-card { transition: all 0.2s; }
        .timer-card.active { border-left: 5px solid #10b981; background-color: #ecfdf5; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.2s ease-out forwards; }
        .modal-content { animation: scaleIn 0.2s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Logic Module -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, initializeFirestore } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let app, auth, db;
        let isFirebaseAvailable = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Robust Initialization
        try {
            // Safe check for __firebase_config
            const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            
            if (configStr) {
                const firebaseConfig = JSON.parse(configStr);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // Force Long Polling for stability
                db = initializeFirestore(app, {
                    experimentalForceLongPolling: true,
                    useFetchStreams: false, 
                });
                isFirebaseAvailable = true;
            } else {
                console.warn("Firebase config not found. Cloud sync will be unavailable.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // Auth Singleton
        let authReadyPromise = new Promise((resolve, reject) => {
            if (!isFirebaseAvailable) {
                // Resolve with null if firebase is missing, handled downstream
                return resolve(null);
            }
            
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    unsubscribe();
                    resolve(user);
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Token sign-in failed", e));
                    } else {
                        signInAnonymously(auth).catch(e => console.error("Anon sign-in failed", e));
                    }
                }
            });
        });

        // Retry Helper
        const retryOperation = async (operation, maxRetries = 2, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i < maxRetries - 1 && (error.code === 'unavailable' || error.message.includes('offline') || error.message.includes('network'))) {
                        console.warn(`Firestore unavailable, retrying... (${i + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        };

        // Expose Service
        window.CloudService = {
            saveData: async (accessKey, data) => {
                if (!isFirebaseAvailable) throw new Error("OFFLINE_MODE (No Config)");
                
                const user = await authReadyPromise;
                if (!user) throw new Error("認證失敗 (Auth Failed)");
                
                try {
                    await retryOperation(async () => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'redmine_timer_v3', accessKey);
                        await setDoc(docRef, { ...data, updatedAt: new Date().toISOString(), savedBy: user.uid }, { merge: true });
                    });
                } catch (e) {
                    if (e.code === 'unavailable' || e.message.includes('offline')) {
                        throw new Error("OFFLINE_MODE");
                    }
                    throw e;
                }
            },
            loadData: async (accessKey) => {
                if (!isFirebaseAvailable) throw new Error("OFFLINE_MODE (No Config)");

                const user = await authReadyPromise;
                if (!user) throw new Error("認證失敗 (Auth Failed)");

                try {
                    return await retryOperation(async () => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'redmine_timer_v3', accessKey);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) return docSnap.data();
                        throw new Error("找不到此金鑰的備份資料");
                    });
                } catch (e) {
                    if (e.code === 'unavailable' || e.message.includes('offline')) {
                        throw new Error("OFFLINE_MODE");
                    }
                    throw e;
                }
            }
        };
    </script>

    <!-- React App -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const FIXED_ACCESS_KEY = 'redmine_diary_report';

        // --- Icon Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const elementRef = useRef(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconKey = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconDef = lucide.icons[iconKey];
                if (iconDef && elementRef.current) {
                    try {
                        const svg = lucide.createElement(iconDef);
                        svg.setAttribute('width', size); svg.setAttribute('height', size); svg.setAttribute('stroke-width', 2);
                        if (className) svg.setAttribute('class', className);
                        elementRef.current.innerHTML = ''; elementRef.current.appendChild(svg);
                    } catch (err) {}
                }
            }, [name, size, className]);
            return <span ref={elementRef} className="inline-flex items-center justify-center" style={{ width: size, height: size }}></span>;
        };

        // --- Modal ---
        const Modal = ({ config, onClose }) => {
            if (!config.isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] modal-overlay p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 modal-content border border-gray-100">
                        <div className="flex items-center gap-3 mb-4 text-gray-800">
                            {config.type === 'confirm' ? <div className="p-2 bg-yellow-100 text-yellow-600 rounded-full"><Icon name="alert-triangle" size={24} /></div> : <div className="p-2 bg-blue-100 text-blue-600 rounded-full"><Icon name="info" size={24} /></div>}
                            <h3 className="text-lg font-bold">{config.title || '提示'}</h3>
                        </div>
                        <p className="text-gray-600 mb-8 ml-1 whitespace-pre-wrap text-sm leading-relaxed">{config.message}</p>
                        <div className="flex justify-end gap-3">
                            {config.type === 'confirm' && <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">取消</button>}
                            <button onClick={() => { if (config.onConfirm) config.onConfirm(); onClose(); }} className={`px-5 py-2 rounded-lg text-white font-bold shadow-sm active:scale-95 ${config.type === 'confirm' ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-800 hover:bg-gray-700'}`}>{config.confirmText || '確定'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, options, setOptions, workSettings, setWorkSettings, staticData, setStaticData, redmineApiConfig, setRedmineApiConfig, userName, setUserName, syncStatus, lastSyncTime, onManualLoad, onManualSave }) => {
            const [localWork, setLocalWork] = useState(workSettings);
            const [localApiConfig, setLocalApiConfig] = useState(redmineApiConfig);
            const [localUserName, setLocalUserName] = useState(userName);
            
            const [projectsJson, setProjectsJson] = useState('');
            const [trackersJson, setTrackersJson] = useState('');
            const [activitiesJson, setActivitiesJson] = useState('');

            useEffect(() => { 
                setLocalWork(workSettings);
                setLocalApiConfig(redmineApiConfig);
                setLocalUserName(userName);
                setProjectsJson(staticData.projects && staticData.projects.length ? JSON.stringify(staticData.projects, null, 2) : '');
                setTrackersJson(staticData.trackers && staticData.trackers.length ? JSON.stringify(staticData.trackers, null, 2) : '');
                setActivitiesJson(staticData.activities && staticData.activities.length ? JSON.stringify(staticData.activities, null, 2) : '');
            }, [workSettings, staticData, redmineApiConfig, userName, isOpen]);

            const parseRedmineJson = (input, key) => {
                if (!input || !input.trim()) return [];
                const cleanInput = input.trim();
                let result = [];
                try {
                    const parsed = JSON.parse(cleanInput);
                    if (Array.isArray(parsed)) {
                        result = parsed;
                    } else if (parsed[key] && Array.isArray(parsed[key])) {
                        result = parsed[key];
                    } else if (parsed.project && parsed.project[key] && Array.isArray(parsed.project[key])) {
                        result = parsed.project[key];
                    } else if (parsed.id && parsed.name) {
                        result = [parsed];
                    }
                } catch (e) {
                    try {
                        const arrayStr = '[' + cleanInput.replace(/}\s*[\r\n]*\s*{/g, '},{') + ']';
                        const parsedArr = JSON.parse(arrayStr);
                        parsedArr.forEach(obj => {
                            if (obj[key] && Array.isArray(obj[key])) result = result.concat(obj[key]);
                            else if (obj.project && obj.project[key] && Array.isArray(obj.project[key])) result = result.concat(obj.project[key]);
                            else if (Array.isArray(obj)) result = result.concat(obj);
                        });
                    } catch (e2) { throw new Error(`無法解析 JSON (${key})`); }
                }
                return result;
            };

            const getAndApplySettings = () => {
                let newProjects = [];
                let newTrackers = [];
                let newActivities = [];
                
                try { newProjects = parseRedmineJson(projectsJson, 'projects'); } catch (e) { alert(e.message); return null; }
                try { newTrackers = parseRedmineJson(trackersJson, 'trackers'); } catch (e) { alert(e.message); return null; }
                try { newActivities = parseRedmineJson(activitiesJson, 'time_entry_activities'); } catch (e) { alert(e.message); return null; }

                const newStaticData = {
                    projects: newProjects.map(p => ({ id: p.id, name: p.name })),
                    trackers: newTrackers.map(t => ({ id: t.id, name: t.name })),
                    activities: newActivities.map(a => ({ id: a.id, name: a.name }))
                };

                setWorkSettings(localWork);
                setRedmineApiConfig(localApiConfig);
                setUserName(localUserName);
                setStaticData(newStaticData);

                return {
                    userName: localUserName,
                    workSettings: localWork,
                    redmineApiConfig: localApiConfig,
                    staticData: newStaticData
                };
            };

            const handleSaveAndClose = () => {
                if (getAndApplySettings()) {
                    onClose();
                }
            };

            const handleForceBackup = () => {
                const currentData = getAndApplySettings();
                if (currentData) {
                    onManualSave(currentData);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 modal-content border border-gray-100 flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icon name="settings" size={20} /> 設定</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icon name="x" /></button>
                        </div>
                        
                        <div className="overflow-y-auto flex-grow pr-2 space-y-6">
                            
                            {/* Cloud Sync Status */}
                            <div className="pb-4 border-b border-gray-100">
                                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="cloud" size={16} /> 雲端同步狀態</h4>
                                <div className="flex flex-col gap-3 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-gray-600">
                                            狀態: <span className={`font-bold ${
                                                syncStatus === 'saved' ? 'text-green-600' : 
                                                syncStatus === 'offline' ? 'text-yellow-600' :
                                                syncStatus === 'error' ? 'text-red-600' : 'text-blue-600'}`}>
                                                {syncStatus === 'saved' ? '已同步' : 
                                                 syncStatus === 'saving' ? '同步中...' : 
                                                 syncStatus === 'offline' ? '暫時離線 (資料存於本地)' :
                                                 syncStatus === 'error' ? '同步失敗' : '等待中'}
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-400">
                                            {lastSyncTime ? new Date(lastSyncTime).toLocaleTimeString() : '尚未同步'}
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-400 font-mono break-all">
                                        Key: {FIXED_ACCESS_KEY}
                                    </div>
                                    <div className="flex gap-2 justify-end mt-1">
                                        <button 
                                            onClick={handleForceBackup}
                                            className="bg-blue-600 text-white hover:bg-blue-700 px-3 py-1.5 rounded text-xs transition-colors flex items-center gap-1 shadow-sm"
                                            title="儲存目前設定並立即上傳雲端"
                                        >
                                            <Icon name="upload-cloud" size={14} /> 強制立即備份
                                        </button>
                                        <button 
                                            onClick={onManualLoad}
                                            className="bg-white border border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded text-xs transition-colors flex items-center gap-1 shadow-sm"
                                        >
                                            <Icon name="download-cloud" size={14} /> 從雲端還原
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Personal Settings */}
                            <div className="pb-4 border-b border-gray-100">
                                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="user" size={16} /> 個人設定</h4>
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">用戶名稱 (User Name)</label>
                                    <input type="text" placeholder="您的姓名 (用於匯出報表)" value={localUserName || ''} onChange={e => setLocalUserName(e.target.value)} className="w-full border rounded px-2 py-1.5 text-sm" />
                                </div>
                            </div>

                            {/* Redmine API Settings */}
                            <div className="pb-4 border-b border-gray-100">
                                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="server" size={16} /> Redmine API 連線</h4>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">網址 (Host URL)</label>
                                        <input 
                                            type="text" 
                                            placeholder="例如: https://igs.redmine-x.com" 
                                            value={localApiConfig.host || ''} 
                                            onChange={e => setLocalApiConfig({...localApiConfig, host: e.target.value})} 
                                            className="w-full border rounded px-2 py-1.5 text-sm" 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">API 金鑰 (API Key)</label>
                                        <input type="password" placeholder="請至 Redmine 個人帳戶頁面取得" value={localApiConfig.apiKey || ''} onChange={e => setLocalApiConfig({...localApiConfig, apiKey: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">CORS 代理 (選填，解決連線阻擋)</label>
                                        <input 
                                            type="text" 
                                            placeholder="例如: https://corsproxy.io/?url=" 
                                            value={localApiConfig.corsProxy || ''} 
                                            onChange={e => setLocalApiConfig({...localApiConfig, corsProxy: e.target.value})} 
                                            className="w-full border rounded px-2 py-1.5 text-sm font-mono text-gray-600" 
                                        />
                                        <p className="text-[10px] text-gray-400 mt-1">
                                            提示：若遇 CORS 錯誤可嘗試使用代理。推薦使用 <code>https://corsproxy.io/?url=</code>。
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Work Hours Settings */}
                            <div className="pb-4 border-b border-gray-100">
                                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="clock" size={16} /> 出勤時間設定</h4>
                                <div className="grid grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">上班時間</label>
                                        <input type="time" value={localWork.startTime} onChange={e => setLocalWork({...localWork, startTime: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">預設下班時間</label>
                                        <input type="time" value={localWork.endTime} onChange={e => setLocalWork({...localWork, endTime: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">午休/休息扣除 (小時)</label>
                                    <input type="number" step="0.5" value={localWork.breakHours} onChange={e => setLocalWork({...localWork, breakHours: parseFloat(e.target.value)})} className="w-full border rounded px-2 py-1.5 text-sm" />
                                </div>
                            </div>

                            {/* JSON Data Import */}
                            <div>
                                <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Icon name="database" size={16} /> 下拉選單資料來源 (JSON)</h4>
                                <p className="text-xs text-gray-500 mb-3">請手動將 Redmine API 的 JSON 回傳結果貼在下方，支援多次貼上。<br/>格式參考: <code>{`{"projects": [{"id": 1, ...}]}`}</code></p>
                                <div className="space-y-3">
                                    <div><label className="text-xs text-gray-500 block mb-1">專案清單 (Projects JSON)</label><textarea value={projectsJson} onChange={e => setProjectsJson(e.target.value)} placeholder='貼上 /projects.json 的內容...' className="w-full border rounded px-2 py-1.5 text-xs font-mono h-16 resize-y focus:border-orange-500 outline-none" /></div>
                                    <div><label className="text-xs text-gray-500 block mb-1">追蹤標籤清單 (Trackers JSON)</label><textarea value={trackersJson} onChange={e => setTrackersJson(e.target.value)} placeholder='貼上 /trackers.json 的內容...' className="w-full border rounded px-2 py-1.5 text-xs font-mono h-16 resize-y focus:border-orange-500 outline-none" /></div>
                                    <div><label className="text-xs text-gray-500 block mb-1">工時-活動類型 (Time Activities JSON)</label><textarea value={activitiesJson} onChange={e => setActivitiesJson(e.target.value)} placeholder='貼上 /enumerations/time_entry_activities.json 的內容...' className="w-full border rounded px-2 py-1.5 text-xs font-mono h-16 resize-y focus:border-orange-500 outline-none" /></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end pt-4 border-t mt-2">
                            <button onClick={handleSaveAndClose} className="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 text-sm font-bold shadow-md">儲存設定並關閉</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Searchable Select Component ---
        const SearchableSelect = ({ label, value, onChange, options = [], placeholder, emptyText = "無資料" }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);
            const inputRef = useRef(null);
            const listRef = useRef(null);

            useEffect(() => {
                const selectedOption = options.find(o => String(o.id) === String(value));
                if (selectedOption) setSearch(selectedOption.name);
                else if (value && value !== search) setSearch(value);
                else if (!value) setSearch('');
            }, [value, options]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // Scroll to selected item when opened
            useEffect(() => {
                if (isOpen && listRef.current) {
                    const selectedEl = listRef.current.querySelector('[data-selected="true"]');
                    if (selectedEl) {
                        selectedEl.scrollIntoView({ block: 'nearest' });
                    }
                }
            }, [isOpen]);

            const filteredOptions = (() => {
                const selectedOption = options.find(o => String(o.id) === String(value));
                if (selectedOption && search === selectedOption.name) {
                    return options;
                }
                return options.filter(o => o.name.toLowerCase().includes(search.toLowerCase()));
            })();

            const handleSelect = (option) => {
                onChange(option.id);
                setSearch(option.name);
                setIsOpen(false);
            };

            const handleInputChange = (e) => {
                const newValue = e.target.value;
                setSearch(newValue);
                onChange(newValue);
                setIsOpen(true);
            };

            const toggleOpen = () => {
                setIsOpen(!isOpen);
                if (!isOpen && inputRef.current) {
                    inputRef.current.focus();
                }
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <label className="text-xs text-gray-500 mb-0.5 block">{label}</label>
                    <div className="relative w-full">
                        <input 
                            ref={inputRef}
                            type="text" 
                            placeholder={placeholder} 
                            value={search} 
                            onChange={handleInputChange} 
                            onFocus={() => setIsOpen(true)} 
                            className="w-full border rounded px-2 py-1.5 focus:border-orange-500 outline-none text-sm bg-white pr-8" 
                        />
                        <div 
                            className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer hover:text-gray-600"
                            onClick={toggleOpen}
                        >
                            <Icon name="chevron-down" size={14} />
                        </div>
                        {isOpen && filteredOptions.length > 0 && (
                            <ul ref={listRef} className="absolute z-50 w-full bg-white border border-gray-200 rounded shadow-lg max-h-48 overflow-y-auto mt-1 text-sm">
                                {filteredOptions.map(option => (
                                    <li 
                                        key={option.id} 
                                        data-selected={String(option.id) === String(value)}
                                        onClick={() => handleSelect(option)} 
                                        className={`px-3 py-2 cursor-pointer hover:bg-orange-50 ${String(option.id) === String(value) ? 'bg-orange-100 text-orange-900 font-medium' : 'text-gray-700'}`}
                                    >
                                        {option.name}
                                    </li>
                                ))}
                            </ul>
                        )}
                        {isOpen && filteredOptions.length === 0 && (
                            <ul className="absolute z-50 w-full bg-white border border-gray-200 rounded shadow-lg mt-1 text-sm">
                                <li className="px-3 py-2 text-gray-400 text-center">{options.length === 0 ? emptyText : "無符合選項 (可直接輸入)"}</li>
                            </ul>
                        )}
                    </div>
                </div>
            );
        };

        // --- Time Input Component ---
        const TimeInput = ({ duration, isRunning, onUpdate }) => {
            const pad = (n) => n.toString().padStart(2, '0');
            const h = Math.floor(duration / 3600000);
            const m = Math.floor((duration % 3600000) / 60000);
            const s = Math.floor((duration % 60000) / 1000);

            const handleChange = (part, value) => {
                const cleanVal = value.replace(/\D/g, '');
                let val = parseInt(cleanVal);
                if (isNaN(val)) val = 0;

                let newDuration = duration;
                if (part === 'h') newDuration = (val * 3600000) + (m * 60000) + (s * 1000);
                if (part === 'm') newDuration = (h * 3600000) + (val * 60000) + (s * 1000);
                if (part === 's') newDuration = (h * 3600000) + (m * 60000) + (val * 1000);

                onUpdate(newDuration);
            };

            const baseInputClass = `bg-transparent border-b border-transparent hover:border-gray-300 focus:border-red-500 focus:outline-none text-center p-0 transition-colors cursor-text ${isRunning ? 'text-green-600' : 'text-gray-600'}`;

            return (
                <div className="font-mono text-2xl font-bold tracking-wider flex items-center justify-end">
                    <input 
                        type="text" 
                        inputMode="numeric"
                        className={`${baseInputClass} w-[3ch] text-right`}
                        value={pad(h)}
                        onChange={(e) => handleChange('h', e.target.value)}
                        onFocus={(e) => e.target.select()}
                        aria-label="Hours"
                    />
                    <span className={`mx-0.5 ${isRunning ? 'text-green-600' : 'text-gray-400'}`}>:</span>
                    <input 
                        type="text" 
                        inputMode="numeric"
                        className={`${baseInputClass} w-[2ch]`}
                        value={pad(m)}
                        onChange={(e) => handleChange('m', e.target.value)}
                        onFocus={(e) => e.target.select()}
                        aria-label="Minutes"
                    />
                    <span className={`mx-0.5 ${isRunning ? 'text-green-600' : 'text-gray-400'}`}>:</span>
                    <input 
                        type="text" 
                        inputMode="numeric"
                        className={`${baseInputClass} w-[2ch] text-gray-400 text-xl`}
                        style={{opacity: isRunning ? 1 : 0.6}}
                        value={pad(s)}
                        onChange={(e) => handleChange('s', e.target.value)}
                        onFocus={(e) => e.target.select()}
                        aria-label="Seconds"
                    />
                </div>
            );
        };

        // --- Task Textarea Component ---
        const TaskTextarea = ({ value, onChange }) => {
            const textareaRef = useRef(null);
            
            useEffect(() => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                    textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
                }
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    value={value}
                    onChange={onChange}
                    rows={1}
                    placeholder="請輸入任務說明..."
                    className="w-full bg-transparent border border-transparent hover:border-gray-200 focus:border-red-500 rounded px-2 py-1 resize-none focus:outline-none focus:bg-white transition-colors text-gray-800 font-medium leading-normal block -ml-2"
                />
            );
        };

        // --- Redmine Gap Filler Component ---
        const RedmineGapFiller = ({ gapHours, date, onSuccess, showAlert, staticData, redmineApiConfig, setRedmineApiConfig }) => {
            const [subject, setSubject] = useState(`補足工時 - ${date}`);
            const [description, setDescription] = useState(`自動補足 ${date} 出勤時數，共 ${gapHours} 小時。`);
            const [doneRatio, setDoneRatio] = useState(100);
            const [loading, setLoading] = useState(false);
            const [createLog, setCreateLog] = useState(true);

            const updateConfig = (key, val) => setRedmineApiConfig(prev => ({ ...prev, [key]: val }));

            // Helper to get fetch URL (apply proxy if needed)
            const getFetchUrl = (url, config) => {
                let target = url;
                if (config.corsProxy) {
                    if (config.corsProxy.trim().endsWith('=')) {
                        return config.corsProxy + encodeURIComponent(target);
                    }
                    return config.corsProxy + target;
                }
                return target;
            };

            const handleCreate = async () => {
                if (!redmineApiConfig.host || !redmineApiConfig.apiKey) return showAlert("錯誤", "請先至右上角「設定」填寫 Redmine URL 與 API Key");
                if (!redmineApiConfig.projectId) return showAlert("錯誤", "請選擇專案");

                setLoading(true);
                let baseUrl = redmineApiConfig.host.trim().replace(/\/$/, '');
                if (!/^https?:\/\//i.test(baseUrl)) baseUrl = 'https://' + baseUrl;
                
                try {
                    const issuePayload = { issue: { project_id: redmineApiConfig.projectId, tracker_id: redmineApiConfig.trackerId, subject: subject, description: description, done_ratio: doneRatio } };
                    
                    const issueUrl = getFetchUrl(`${baseUrl}/issues.json`, redmineApiConfig);
                    
                    const issueRes = await fetch(issueUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json', 'X-Redmine-API-Key': redmineApiConfig.apiKey }, 
                        body: JSON.stringify(issuePayload) 
                    });
                    
                    if (!issueRes.ok) throw new Error(`建立 Issue 失敗: ${issueRes.status} ${issueRes.statusText}`);
                    const issueData = await issueRes.json();
                    const newIssueId = issueData.issue.id;
                    let successMsg = `成功建立 Issue #${newIssueId}！`;

                    if (createLog) {
                        if (!redmineApiConfig.timeActivityId) throw new Error("回報工時需填寫工時活動 ID");
                        
                        const timeUrl = getFetchUrl(`${baseUrl}/time_entries.json`, redmineApiConfig);
                        
                        const timeRes = await fetch(timeUrl, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'X-Redmine-API-Key': redmineApiConfig.apiKey }, 
                            body: JSON.stringify({ time_entry: { issue_id: newIssueId, hours: gapHours, activity_id: redmineApiConfig.timeActivityId, spent_on: date, comments: '系統自動補單' } }) 
                        });
                        
                        if (!timeRes.ok) throw new Error(`工時回報失敗: ${timeRes.status}`);
                        successMsg += `\n並已寫入 ${gapHours} 小時工時。`;
                    }
                    showAlert("成功", successMsg);
                    if (onSuccess) onSuccess(newIssueId, gapHours);
                } catch (e) {
                    console.error("API Error:", e);
                    let title = "API 連線失敗"; let msg = e.message;
                    if (e.name === 'TypeError' && e.message === 'Failed to fetch') { 
                        title = "連線被阻擋"; 
                        msg = "無法連接到伺服器。\n\n";
                        if (redmineApiConfig.corsProxy) {
                            msg += "您已啟用 CORS 代理，但請求仍然失敗。\n可能原因：\n1. 代理伺服器不支援 POST 請求或自訂 Header。\n2. 代理伺服器網址錯誤或已失效。\n\n建議：更換代理服務 (如 corsproxy.io) 或下載本機執行。";
                        } else {
                            msg += "可能原因：\n1. 跨網域 (CORS) 限制。\n2. 混合內容 (HTTPS 呼叫 HTTP)。\n\n建議：\n- 在設定中啟用「CORS 代理」。\n- 下載至本機執行。";
                        }
                    }
                    showAlert(title, msg);
                } finally { setLoading(false); }
            };

            const hasStaticData = staticData.projects.length > 0 || staticData.trackers.length > 0;

            return (
                <div className="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6 shadow-sm text-sm">
                    <div className="flex items-center gap-2 mb-4 text-orange-800 font-bold text-base"><Icon name="alert-circle" size={20} /><span>工時不足 {gapHours} 小時，快速補單</span></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="space-y-3 p-3 bg-orange-100/50 rounded-lg border border-orange-100">
                            <div className="flex justify-between items-center"><label className="block font-bold text-orange-900 flex items-center gap-1"><Icon name="settings-2" size={14} /> Redmine 設定</label>{hasStaticData && <span className="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded">已載入設定資料</span>}</div>
                            {(!redmineApiConfig.host || !redmineApiConfig.apiKey) && <div className="text-xs text-red-600 bg-red-50 p-2 rounded border border-red-200"><Icon name="alert-triangle" size={12} className="inline mr-1"/>請點擊右上角「設定」按鈕，填寫 Redmine 網址與 API Key。</div>}
                            <SearchableSelect label="專案 (Project)" placeholder="輸入 ID 或搜尋..." value={redmineApiConfig.projectId} onChange={(val) => updateConfig('projectId', val)} options={staticData.projects} emptyText="無資料，請至設定貼上 JSON" />
                            <div className="grid grid-cols-2 gap-2">
                                <SearchableSelect label="追蹤標籤 (Tracker)" placeholder="輸入 ID 或搜尋..." value={redmineApiConfig.trackerId} onChange={(val) => updateConfig('trackerId', val)} options={staticData.trackers} emptyText="無資料，請至設定貼上 JSON" />
                                <SearchableSelect label="工時-活動類型 (Activity)" placeholder="輸入 ID 或搜尋..." value={redmineApiConfig.timeActivityId} onChange={(val) => updateConfig('timeActivityId', val)} options={staticData.activities} emptyText="無資料，請至設定貼上 JSON" />
                            </div>
                        </div>
                        <div className="space-y-3 p-3 bg-white rounded-lg border border-gray-200">
                            <label className="block font-bold text-gray-700 flex items-center gap-1"><Icon name="file-plus" size={14} /> 補單內容</label>
                            <div><label className="text-xs text-gray-500 mb-0.5 block">主旨</label><input type="text" placeholder="主旨" value={subject} onChange={e=>setSubject(e.target.value)} className="w-full border rounded px-2 py-1.5 focus:border-orange-500 outline-none" /></div>
                            <div><label className="text-xs text-gray-500 mb-0.5 block">概述</label><textarea placeholder="概述" rows={4} value={description} onChange={e=>setDescription(e.target.value)} className="w-full border rounded px-2 py-1.5 resize-none focus:border-orange-500 outline-none" /></div>
                            <div><label className="text-xs text-gray-500 mb-0.5 block">完成百分比</label><select value={doneRatio} onChange={e=>setDoneRatio(e.target.value)} className="w-full border rounded px-2 py-1.5 focus:border-orange-500 outline-none bg-white">{[0,10,20,30,40,50,60,70,80,90,100].map(r => <option key={r} value={r}>{r}%</option>)}</select></div>
                        </div>
                    </div>
                    <div className="flex items-center justify-between pt-3 border-t border-orange-200">
                        <label className="flex items-center gap-2 text-gray-700 cursor-pointer select-none font-medium"><input type="checkbox" checked={createLog} onChange={e=>setCreateLog(e.target.checked)} className="rounded text-orange-600 focus:ring-orange-500" /><span>同時回報工時 (Log Time)</span></label>
                        <button onClick={handleCreate} disabled={loading} className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2.5 rounded-lg font-bold flex items-center gap-2 disabled:opacity-50 transition-colors shadow-sm">{loading ? <Icon name="loader-2" className="animate-spin" size={18} /> : <Icon name="send" size={18} />}{loading ? "處理中..." : "建立單據"}</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [tasks, setTasks] = useState(() => { try { return JSON.parse(localStorage.getItem('redmine_tasks') || '[]').map(t => ({...t, isRunning: false})); } catch { return []; } });
            const [globalDate, setGlobalDate] = useState(() => localStorage.getItem('redmine_date') || new Date().toISOString().split('T')[0]);
            const [userName, setUserName] = useState(() => localStorage.getItem('redmine_user_v2') || '');
            const [workSettings, setWorkSettings] = useState(() => { try { return JSON.parse(localStorage.getItem('redmine_work_settings') || '{"startTime":"09:00", "endTime":"18:00", "breakHours": 1}'); } catch { return {startTime:"09:00", endTime:"18:00", breakHours: 1}; } });
            const [redmineApiConfig, setRedmineApiConfig] = useState(() => { 
                try { 
                    const stored = JSON.parse(localStorage.getItem('redmine_api_config') || '{}');
                    return { ...stored, host: stored.host || 'https://igs.redmine-x.com' };
                } catch { 
                    return { host: 'https://igs.redmine-x.com' }; 
                } 
            });
            const [staticData, setStaticData] = useState(() => { try { const stored = JSON.parse(localStorage.getItem('redmine_static_data') || '{}'); return { projects: stored.projects || [], trackers: stored.trackers || [], activities: stored.activities || [] }; } catch { return { projects: [], trackers: [], activities: [] }; } });

            const [newTask, setNewTask] = useState({ issueId: '', comment: '', activityId: staticData.activities[0]?.name || 'Development', projectName: '' });
            const [roundTo, setRoundTo] = useState(0.25);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: 'alert', title: '', message: '' });
            const [isLoading, setIsLoading] = useState(false);
            const commentInputRef = useRef(null);
            
            // Sync State
            const [isServiceReady, setIsServiceReady] = useState(false);
            const [isInitialized, setIsInitialized] = useState(false);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [lastSyncTime, setLastSyncTime] = useState(null);
            
            // Ref to hold latest state for sync function
            const stateRef = useRef({ tasks, userName, globalDate, workSettings, staticData, redmineApiConfig });
            useEffect(() => {
                stateRef.current = { tasks, userName, globalDate, workSettings, staticData, redmineApiConfig };
            }, [tasks, userName, globalDate, workSettings, staticData, redmineApiConfig]);

            // Persistence LocalStorage
            useEffect(() => localStorage.setItem('redmine_user_v2', userName), [userName]);
            useEffect(() => { localStorage.setItem('redmine_tasks', JSON.stringify(tasks)); localStorage.setItem('redmine_date', globalDate); }, [tasks, globalDate]);
            useEffect(() => localStorage.setItem('redmine_work_settings', JSON.stringify(workSettings)), [workSettings]);
            useEffect(() => localStorage.setItem('redmine_static_data', JSON.stringify(staticData)), [staticData]); 
            useEffect(() => localStorage.setItem('redmine_api_config', JSON.stringify(redmineApiConfig)), [redmineApiConfig]);
            
            useEffect(() => {
                if (staticData.activities.length > 0) {
                    const activityNames = staticData.activities.map(a => a.name);
                    if (!activityNames.includes(newTask.activityId)) setNewTask(p => ({...p, activityId: activityNames[0]}));
                }
            }, [staticData.activities]);

            useEffect(() => {
                const interval = setInterval(() => setTasks(ts => ts.map(t => t.isRunning ? {...t, duration: t.duration + 1000} : t)), 1000);
                return () => clearInterval(interval);
            }, []);

            // Wait for Service Ready
            useEffect(() => {
                const checkService = () => {
                    if (window.CloudService) {
                        setIsServiceReady(true);
                        return true;
                    }
                    return false;
                };
                if (!checkService()) {
                    const interval = setInterval(() => {
                        if (checkService()) clearInterval(interval);
                    }, 200);
                    return () => clearInterval(interval);
                }
            }, []);

            // --- Unified Cloud Sync Function ---
            const saveToCloud = useCallback(async (dataOverride = null) => {
                if (!window.CloudService) return;
                setSyncStatus('saving');
                try {
                    // Use ref to get latest state, ensuring no stale closures and no dependency on 'tasks' triggering this unless intended
                    const currentState = stateRef.current;
                    const dataToSave = dataOverride || { 
                        userName: currentState.userName, 
                        tasks: currentState.tasks.map(t => ({...t, isRunning: false})), 
                        globalDate: currentState.globalDate, 
                        workSettings: currentState.workSettings, 
                        staticData: currentState.staticData, 
                        redmineApiConfig: currentState.redmineApiConfig 
                    }; 
                    await window.CloudService.saveData(FIXED_ACCESS_KEY, dataToSave);
                    setSyncStatus('saved');
                    setLastSyncTime(new Date());
                } catch (e) { 
                    if (e.message.includes('OFFLINE_MODE')) {
                         console.log("Auto Sync: Running in offline mode."); // Changed from error to log
                         setSyncStatus('offline');
                    } else {
                         console.error("Auto Sync Error:", e);
                         setSyncStatus('error');
                    }
                }
            }, []);

            // --- Initial Auto-Load from Cloud ---
            useEffect(() => {
                if (!isServiceReady) return;

                const init = async () => {
                    try {
                        const data = await window.CloudService.loadData(FIXED_ACCESS_KEY);
                        if (data) {
                            if (data.userName) setUserName(data.userName);
                            if (data.tasks) setTasks(data.tasks.map(t => ({...t, isRunning: false})));
                            if (data.globalDate) setGlobalDate(data.globalDate);
                            if (data.workSettings) setWorkSettings(data.workSettings);
                            if (data.staticData) setStaticData(data.staticData);
                            if (data.redmineApiConfig) setRedmineApiConfig(data.redmineApiConfig);
                            
                            setLastSyncTime(new Date(data.updatedAt || Date.now()));
                            setSyncStatus('saved');
                        }
                    } catch (e) {
                         if (e.message.includes('OFFLINE_MODE')) {
                             setSyncStatus('offline');
                         }
                    } finally {
                        setIsInitialized(true);
                    }
                };
                init();
            }, [isServiceReady]);

            // --- Effect 1: Auto-Save for SETTINGS changes (Fast debounce 500ms) ---
            useEffect(() => {
                if (!isInitialized) return; 
                const timer = setTimeout(() => {
                    saveToCloud();
                }, 500);
                return () => clearTimeout(timer);
            }, [userName, workSettings, staticData, redmineApiConfig, saveToCloud, isInitialized]);

            // --- Effect 2: Auto-Save for TASKS changes (Slow debounce 5000ms) ---
            useEffect(() => {
                if (!isInitialized) return;
                const timer = setTimeout(() => {
                    saveToCloud();
                }, 5000);
                return () => clearTimeout(timer);
            }, [tasks, saveToCloud, isInitialized]);


            // --- Manual Cloud Load ---
            const handleManualLoad = () => {
                showConfirm("確認還原", "這將會使用雲端上的資料覆蓋您目前的設定與任務，確定執行嗎？", async () => {
                    try {
                        const data = await window.CloudService.loadData(FIXED_ACCESS_KEY);
                        if (data.userName) setUserName(data.userName);
                        if (data.tasks) setTasks(data.tasks);
                        if (data.globalDate) setGlobalDate(data.globalDate);
                        if (data.workSettings) setWorkSettings(data.workSettings);
                        if (data.staticData) setStaticData(data.staticData);
                        if (data.redmineApiConfig) setRedmineApiConfig(data.redmineApiConfig);
                        setLastSyncTime(new Date(data.updatedAt || Date.now()));
                        showAlert("還原成功", "資料已同步至最新狀態！");
                    } catch (e) { 
                        const msg = e.message.includes('OFFLINE_MODE') ? "目前無法連線至雲端 (離線模式)" : e.message;
                        showAlert("還原失敗", msg); 
                    }
                });
            };

            const showConfirm = (title, message, onConfirm) => setModalConfig({ isOpen: true, type: 'confirm', title, message, onConfirm });
            const showAlert = (title, message) => setModalConfig({ isOpen: true, type: 'alert', title, message });
            const closeModal = () => setModalConfig(p => ({...p, isOpen: false}));

            const addTask = (e) => { e.preventDefault(); if (!newTask.issueId) return; setTasks([...tasks, { id: Date.now(), ...newTask, duration: 0, isRunning: false }]); setNewTask({ ...newTask, issueId: '', comment: '' }); };
            const updateTask = (id, f, v) => setTasks(ts => ts.map(t => t.id===id ? {...t, [f]: v} : t));
            const toggleTimer = (id) => setTasks(ts => ts.map(t => t.id===id ? {...t, isRunning: !t.isRunning} : {...t, isRunning: false}));
            const adjustTime = (id, m) => setTasks(ts => ts.map(t => t.id===id ? {...t, duration: Math.max(0, t.duration + m*60000)} : t));
            const updateTaskDuration = (id, newDuration) => setTasks(tasks.map(task => task.id === id ? { ...task, duration: Math.max(0, newDuration) } : task));
            const deleteTask = (id) => showConfirm("刪除", "確定刪除?", () => setTasks(ts => ts.filter(t => t.id !== id)));
            const clearAll = () => showConfirm("清空", "確定清空?", () => { setTasks([]); localStorage.removeItem('redmine_tasks'); });
            
            const getDecimalHours = (ms) => { const h = ms / 3600000; return roundTo === 0 ? h.toFixed(2) : (Math.ceil(h / roundTo) * roundTo).toFixed(2); };

            const totalHours = tasks.reduce((acc, curr) => acc + parseFloat(getDecimalHours(curr.duration)), 0);
            
            const calculateExpectedHours = () => {
                const start = new Date(`2000-01-01T${workSettings.startTime}`);
                const end = new Date(`2000-01-01T${workSettings.endTime}`);
                let diff = (end - start) / 3600000;
                diff -= workSettings.breakHours;
                return Math.max(0, diff);
            };
            const expectedHours = calculateExpectedHours();
            const gapHours = (expectedHours - totalHours).toFixed(2);
            const isGap = parseFloat(gapHours) > 0;

            const exportCSV = () => {
                if (!userName.trim()) return showAlert("錯誤", "請先至「設定」輸入用戶名稱");
                const BOM = "\uFEFF";
                const headers = ["專案", "日期", "用戶", "活動", "議題", "回應", "小時"];
                const rows = tasks.map(t => {
                    const h = getDecimalHours(t.duration);
                    if (parseFloat(h) <= 0) return null;
                    return [`"${(t.projectName||'').replace(/"/g,'""')}"`, globalDate, userName, t.activityId, t.issueId, `"${t.comment.replace(/"/g,'""').replace(/\n/g,'\u3000')}"`, h].join(",");
                }).filter(r => r);
                if (!rows.length) return showAlert("錯誤", "無有效工時");
                const url = URL.createObjectURL(new Blob([BOM + headers.join(",") + "\r\n" + rows.join("\r\n")], {type: "text/csv;charset=utf-8;"}));
                const link = document.createElement("a"); link.href = url; link.download = `redmine_${globalDate}.csv`; link.click();
            };

            const stepMinutes = roundTo > 0 ? Math.round(roundTo * 60) : 1;

            return (
                <div className="min-h-screen pb-10 relative">
                    <Modal config={modalConfig} onClose={closeModal} />
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        options={[]} 
                        setOptions={()=>{}} 
                        workSettings={workSettings} 
                        setWorkSettings={setWorkSettings} 
                        staticData={staticData} 
                        setStaticData={setStaticData} 
                        redmineApiConfig={redmineApiConfig} 
                        setRedmineApiConfig={setRedmineApiConfig}
                        userName={userName}
                        setUserName={setUserName}
                        syncStatus={syncStatus}
                        lastSyncTime={lastSyncTime}
                        onManualLoad={handleManualLoad}
                        onManualSave={saveToCloud}
                    />

                    {/* Header */}
                    <div className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-2 w-full sm:w-auto">
                                <div className="p-2 bg-red-700 text-white rounded-lg"><Icon name="clock" /></div>
                                <h1 className="text-xl font-bold text-gray-800 mr-2">Redmine 工時助手</h1>
                                
                                {/* Sync Status Indicator */}
                                <div className="flex items-center gap-1 text-xs" title={`雲端同步狀態: ${syncStatus === 'saved' ? '已儲存' : syncStatus === 'saving' ? '儲存中...' : syncStatus === 'offline' ? '暫時離線 (資料存於本地)' : syncStatus === 'error' ? '錯誤' : '等待中'}`}>
                                    {syncStatus === 'saving' ? (
                                        <Icon name="loader-2" size={16} className="text-blue-500 animate-spin" />
                                    ) : syncStatus === 'saved' ? (
                                        <Icon name="cloud" size={16} className="text-green-500" />
                                    ) : syncStatus === 'offline' ? (
                                        <Icon name="cloud-off" size={16} className="text-yellow-500" />
                                    ) : syncStatus === 'error' ? (
                                        <Icon name="alert-circle" size={16} className="text-red-500" />
                                    ) : (
                                        <Icon name="cloud" size={16} className="text-gray-300" />
                                    )}
                                </div>

                                <button onClick={() => setIsSettingsOpen(true)} className="ml-2 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors" title="設定"><Icon name="settings" size={20} /></button>
                            </div>
                            <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                <div className="text-right">
                                    <div className="text-xs text-gray-500">預計下班</div>
                                    <input type="time" value={workSettings.endTime} onChange={e => setWorkSettings({...workSettings, endTime: e.target.value})} className="font-mono bg-transparent border-b border-gray-300 focus:border-red-500 outline-none w-36" />
                                </div>
                                <div className="text-right">
                                    <div className="text-xs text-gray-500">日期</div>
                                    <input type="date" value={globalDate} onChange={e => setGlobalDate(e.target.value)} className="font-mono bg-transparent border-b border-gray-300 focus:border-red-500 outline-none" />
                                </div>
                                <div className="text-right pl-4 border-l">
                                    <div className="text-xs text-gray-500">目標 {expectedHours.toFixed(1)} / 已記 {totalHours.toFixed(2)}</div>
                                    <div className={`text-2xl font-bold font-mono ${isGap ? 'text-orange-500' : 'text-green-600'}`}>{isGap ? `-${gapHours}` : 'OK'} <span className="text-sm text-gray-400">hr</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-4xl mx-auto px-4 mt-6">
                        
                        {/* Gap Filler */}
                        {isGap && <RedmineGapFiller gapHours={gapHours} date={globalDate} showAlert={showAlert} staticData={staticData} onSuccess={()=>{}} redmineApiConfig={redmineApiConfig} setRedmineApiConfig={setRedmineApiConfig} />}

                        {/* Control Panel */}
                        <div className="bg-white p-6 rounded-xl shadow-sm mb-6">
                            <form onSubmit={addTask} className="flex flex-col gap-4">
                                <div className="flex flex-col md:flex-row gap-4 items-start">
                                    <div className="flex-none md:w-32 w-full">
                                        <label className="text-xs text-gray-500 mb-1 block">Issue ID #</label>
                                        <input type="number" placeholder="12345" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none" value={newTask.issueId} onChange={e => setNewTask({...newTask, issueId: e.target.value})} required />
                                    </div>
                                    <div className="flex-none md:w-40 w-full">
                                        <label className="text-xs text-gray-500 mb-1 block">專案 (選填)</label>
                                        <input type="text" placeholder="專案名稱" className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none" value={newTask.projectName} onChange={e => setNewTask({...newTask, projectName: e.target.value})} />
                                    </div>
                                    <div className="flex-grow w-full">
                                        <label className="text-xs text-gray-500 mb-1 block">任務說明</label>
                                        <textarea placeholder="說明..." className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:outline-none resize-y overflow-hidden leading-normal" rows={1} value={newTask.comment} onChange={e => { setNewTask({...newTask, comment: e.target.value}); e.target.style.height='auto'; e.target.style.height=e.target.scrollHeight+'px'; }} style={{minHeight:'42px'}} />
                                    </div>
                                </div>
                                <div className="flex flex-col md:flex-row gap-4">
                                    <div className="flex-none md:w-48">
                                         <label className="text-xs text-gray-500 mb-1 block">活動類型</label>
                                         <div className="flex gap-2">
                                            {staticData.activities.length > 0 ? (
                                                <select className="flex-grow bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" value={newTask.activityId} onChange={e => setNewTask({...newTask, activityId: e.target.value})}>
                                                    {staticData.activities.map(opt => <option key={opt.id} value={opt.name}>{opt.name}</option>)}
                                                </select>
                                            ) : (
                                                <div className="flex-grow text-xs text-gray-400 border border-dashed rounded px-2 py-2 text-center bg-gray-50">請至設定匯入 JSON</div>
                                            )}
                                         </div>
                                    </div>
                                    <div className="flex-grow">
                                        {/* User Name Removed from main UI */}
                                    </div>
                                    <div className="flex-none flex items-end">
                                        <button type="submit" className="w-full bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center justify-center gap-2"><Icon name="plus" size={18} /> 新增任務</button>
                                    </div>
                                </div>
                            </form>
                            <div className="mt-4 pt-4 border-t flex items-center justify-between text-sm text-gray-500">
                                <div className="flex items-center gap-2"><span>進位單位：</span><select value={roundTo} onChange={e => setRoundTo(parseFloat(e.target.value))} className="bg-gray-100 border-none rounded px-2 py-1"><option value={0}>不進位</option><option value={0.1}>0.1 小時 (6分)</option><option value={0.25}>0.25 小時 (15分)</option><option value={0.5}>0.5 小時 (30分)</option></select></div>
                            </div>
                        </div>

                        {/* Task List */}
                        <div className="space-y-3">
                            {tasks.length === 0 && <div className="text-center py-12 text-gray-400 bg-white rounded-xl border-2 border-dashed border-gray-200"><Icon name="coffee" size={48} className="mx-auto mb-3 opacity-50" /><p>輸入 Issue ID 開始工作吧！</p></div>}
                            {tasks.map(task => (
                                <div key={task.id} className={`timer-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row items-center justify-between gap-4 ${task.isRunning ? 'active' : ''}`}>
                                    <div className="flex items-center gap-4 flex-grow w-full sm:w-auto">
                                        <div className={`p-3 rounded-full flex-shrink-0 ${task.isRunning ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>{task.isRunning ? <Icon name="play" className="fill-current" /> : <Icon name="pause" />}</div>
                                        <div className="flex-grow min-w-0">
                                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                                <div className="flex items-center bg-gray-100 rounded px-1.5 py-0.5 hover:bg-gray-200 group focus-within:ring-1 focus-within:ring-red-500">
                                                    <span className="text-xs text-gray-500 font-bold mr-0.5">#</span>
                                                    <input type="text" value={task.issueId} onChange={e => updateTask(task.id, 'issueId', e.target.value)} className="bg-transparent border-none outline-none text-xs font-bold text-gray-700 w-14 font-mono" />
                                                </div>
                                                <input type="text" value={task.projectName} onChange={e => updateTask(task.id, 'projectName', e.target.value)} placeholder="專案..." className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100 hover:border-blue-300 focus:border-blue-500 outline-none w-24 placeholder-blue-300" />
                                                {staticData.activities.length > 0 ? (
                                                    <select value={task.activityId} onChange={e => updateTask(task.id, 'activityId', e.target.value)} className="text-xs text-gray-500 border border-gray-200 hover:border-gray-400 bg-white rounded px-1 py-0.5 focus:border-red-500 outline-none max-w-[120px]">
                                                        {staticData.activities.map(opt => <option key={opt.id} value={opt.name}>{opt.name}</option>)}
                                                    </select>
                                                ) : (
                                                    <span className="text-xs text-gray-400 border border-dashed rounded px-1 py-0.5">無選項</span>
                                                )}
                                            </div>
                                            <TaskTextarea value={task.comment} onChange={e => updateTask(task.id, 'comment', e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                        <div className="text-right">
                                            <TimeInput duration={task.duration} isRunning={task.isRunning} onUpdate={d => updateTaskDuration(task.id, d)} />
                                            <div className="text-xs text-gray-400 font-mono text-right mt-1">≈ {getDecimalHours(task.duration)} hr</div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => toggleTimer(task.id)} className={`p-2 rounded-lg transition-colors ${task.isRunning ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>{task.isRunning ? <Icon name="pause" /> : <Icon name="play" />}</button>
                                        </div>
                                    </div>
                                    <div className="flex sm:flex-col gap-2 border-t sm:border-t-0 sm:border-l pt-3 sm:pt-0 sm:pl-3 w-full sm:w-auto justify-center">
                                        <div className="flex gap-2">
                                            <button onClick={() => adjustTime(task.id, stepMinutes)} className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600">+{stepMinutes}m</button>
                                            <button onClick={() => adjustTime(task.id, -stepMinutes)} className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600">-{stepMinutes}m</button>
                                        </div>
                                        <button onClick={() => deleteTask(task.id)} className="text-red-400 hover:text-red-600 text-sm flex items-center justify-center gap-1 mt-1"><Icon name="trash-2" size={14} /> 刪除</button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {tasks.length > 0 && (
                            <div className="mt-8 flex justify-between items-center bg-gray-800 text-white p-4 rounded-xl shadow-lg">
                                <div className="text-sm text-gray-300 hidden sm:block">準備下班了嗎？</div>
                                <div className="flex gap-3 w-full sm:w-auto justify-end">
                                    <button onClick={clearAll} className="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">清空列表</button>
                                    <button onClick={exportCSV} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transform active:scale-95 transition-all"><Icon name="download" size={18} /> 匯出 CSV</button>
                                </div>
                            </div>
                        )}
                        <div className="mt-8 text-center text-xs text-gray-400 pb-8">匯出的 CSV 格式包含 BOM 標頭，Excel 可直接開啟不亂碼。</div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
